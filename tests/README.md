# Test Organization

## ğŸ“ Directory Structure

```
tests/
â”œâ”€â”€ README.md                          # This file
â”œâ”€â”€ fixtures.ts                        # Shared test fixtures
â”œâ”€â”€ test-constants.ts                  # Test IDs and routes
â”œâ”€â”€ state-helpers.ts                   # State assertion helpers
â”‚
â”œâ”€â”€ generated/                         # âš ï¸  AUTO-GENERATED - DO NOT EDIT
â”‚   â””â”€â”€ stories/                       # Generated from .feature files
â”‚       â”œâ”€â”€ chat-component.spec.ts     # Generated from features/chat.feature
â”‚       â”œâ”€â”€ counter-component.spec.ts  # Generated from features/counter.feature
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ *.spec.ts                          # âš ï¸  LEGACY - MIGRATE TO STORIES
â”‚   â”œâ”€â”€ ai-command-test.spec.ts        # Should be features/ai-commands.feature
â”‚   â”œâ”€â”€ auto-generated.spec.ts         # Should be features/tool-generation.feature
â”‚   â”œâ”€â”€ clickable-tools.spec.ts        # Should be features/clickable-tools.feature
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ e2e/                               # âš ï¸  LEGACY - MIGRATE TO STORIES
    â””â”€â”€ *.spec.ts                      # End-to-end tests
```

## âœ… Preferred Approach: Story System

**Write tests as Gherkin feature files**, then auto-generate Playwright tests.

### Benefits:
- âœ… **Reusable** - Background steps run before every scenario
- âœ… **Hierarchical** - Compose complex flows from simple steps
- âœ… **Cached** - State-aware caching (50-80% faster)
- âœ… **Type-safe** - Uses data contracts instead of magic strings
- âœ… **Maintainable** - Single source of truth in `.feature` files

### Example:

**features/chat.feature**:
```gherkin
Feature: Chat Component

  Background:
    Given I am on Routes.Demo
    Given Components.Chat.bubble is visible
    When I click Components.Chat.bubble  # Reusable across all scenarios!

  Scenario: Send a message
    When I type "Hello" in Components.Chat.input
    And I click Components.Chat.sendButton
    Then Components.Chat.messages should contain 1 message
```

**Generate tests**:
```bash
npm run story:generate
```

**Generated test** (in `tests/generated/stories/`):
```typescript
/**
 * âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT
 *
 * This file is automatically generated from Gherkin feature files.
 * To make changes:
 *   1. Edit the .feature file in features/
 *   2. Run: npm run story:generate
 */

test('Send a message', async ({ page }) => {
  // Background steps - automatically included!
  await page.goto(`${Routes.Demo}`);
  await page.locator(testId(Chat.bubble)).first().waitFor({ state: 'visible' });
  await page.locator(testId(Chat.bubble)).first().click(); // âœ…

  // Scenario steps
  await page.locator(testId(Chat.input)).fill('Hello');
  await page.locator(testId(Chat.sendButton)).first().click();
  // ...
});
```

## âš ï¸  Legacy Manual Tests

The `*.spec.ts` files in `tests/` are **legacy tests** that should be migrated to the story system.

### Why Migrate?

Manual tests like `ai-command-test.spec.ts`, `clickable-tools.spec.ts`, etc. have problems:
- âŒ **Duplicated code** - Every test manually calls `expandChatBubble(page)`
- âŒ **No caching** - Every test runs setup from scratch
- âŒ **Hard to maintain** - Changes must be made in multiple places
- âŒ **No composition** - Can't reuse steps across tests

### Migration Plan:

1. **Choose a legacy test** (e.g., `ai-command-test.spec.ts`)
2. **Create a `.feature` file** in `features/` (e.g., `features/ai-commands.feature`)
3. **Write scenarios** using Gherkin syntax
4. **Generate tests** with `npm run story:generate`
5. **Verify** generated tests pass
6. **Archive** old manual test (move to `tests/archive/`)

## ğŸ“š Documentation

- [Story System Overview](../content/docs/story-system/00_README.md)
- [Getting Started](../content/docs/story-system/00_GETTING_STARTED.md)
- [State-Aware Caching](../content/docs/story-system/04_STATE_AWARE_CACHING.md)

## ğŸ¯ Quick Start

```bash
# Create a new feature
vi features/my-feature.feature

# Generate tests
npm run story:generate

# Run generated tests
npm run test:stories

# Or run all tests (includes manual + generated)
npm test
```

## â“ FAQ

**Q: Can I still write manual tests?**
A: Yes, but only for one-off scenarios that don't fit the story system. Most tests should be stories.

**Q: What about the `expandChatBubble` helper?**
A: It's needed for legacy tests. New story-based tests use Background steps instead.

**Q: How do I update a generated test?**
A: Edit the `.feature` file and run `npm run story:generate`. Never edit generated files directly.

**Q: What about test fixtures and helpers?**
A: Keep using `fixtures.ts`, `test-constants.ts`, and `state-helpers.ts` - they work with both systems.
