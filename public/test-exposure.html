<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ExposureCollector Test Suite</title>
  <style>
    body {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 {
      color: #4ec9b0;
      border-bottom: 2px solid #4ec9b0;
      padding-bottom: 10px;
    }
    h2 {
      color: #9cdcfe;
      margin-top: 30px;
    }
    .test {
      background: #2d2d2d;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #569cd6;
      border-radius: 4px;
    }
    .test-title {
      color: #dcdcaa;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    .pass {
      background: #1a3a1a;
      border-left: 4px solid #4ec9b0;
      color: #4ec9b0;
    }
    .fail {
      background: #3a1a1a;
      border-left: 4px solid #f14c4c;
      color: #f14c4c;
    }
    .info {
      background: #1a2a3a;
      border-left: 4px solid #569cd6;
      color: #9cdcfe;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 12px 24px;
      margin: 10px 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    button:hover {
      background: #1177bb;
    }
    .code {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 5px 0;
    }
    pre {
      margin: 0;
      color: #ce9178;
    }
    .summary {
      background: #2d2d2d;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h1>üß™ ExposureCollector Auto-Initialization Test Suite</h1>
  <p style="color: #808080;">Testing zero-config element-based tool inference</p>

  <div style="margin: 20px 0;">
    <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    <button onclick="window.location.href='http://localhost:3000/demo'">üîÑ Go to Demo Page</button>
  </div>

  <div id="results"></div>

  <script>
    let testResults = [];

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      testResults = [];
    }

    function addResult(title, pass, message, details = null) {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'test';

      const titleDiv = document.createElement('div');
      titleDiv.className = 'test-title';
      titleDiv.textContent = title;

      const resultContent = document.createElement('div');
      resultContent.className = `result ${pass ? 'pass' : 'fail'}`;
      resultContent.innerHTML = `${pass ? '‚úÖ' : '‚ùå'} ${message}`;

      resultDiv.appendChild(titleDiv);
      resultDiv.appendChild(resultContent);

      if (details) {
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'code';
        detailsDiv.innerHTML = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
        resultDiv.appendChild(detailsDiv);
      }

      document.getElementById('results').appendChild(resultDiv);
      testResults.push({ title, pass, message });
    }

    function addInfo(title, message, details = null) {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'test';

      const titleDiv = document.createElement('div');
      titleDiv.className = 'test-title';
      titleDiv.textContent = title;

      const resultContent = document.createElement('div');
      resultContent.className = 'result info';
      resultContent.innerHTML = `‚ÑπÔ∏è ${message}`;

      resultDiv.appendChild(titleDiv);
      resultDiv.appendChild(resultContent);

      if (details) {
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'code';
        detailsDiv.innerHTML = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
        resultDiv.appendChild(detailsDiv);
      }

      document.getElementById('results').appendChild(resultDiv);
    }

    function showSummary() {
      const total = testResults.length;
      const passed = testResults.filter(r => r.pass).length;
      const failed = total - passed;
      const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;

      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'summary';
      summaryDiv.innerHTML = `
        <h2 style="margin-top: 0;">üìä Test Summary</h2>
        <div style="font-size: 24px; margin: 15px 0;">
          <span style="color: #4ec9b0;">‚úÖ ${passed} passed</span> |
          <span style="color: #f14c4c;">‚ùå ${failed} failed</span> |
          <span style="color: #dcdcaa;">${passRate}% pass rate</span>
        </div>
        <div style="color: ${passRate === 100 ? '#4ec9b0' : passRate >= 80 ? '#dcdcaa' : '#f14c4c'};">
          ${passRate === 100 ? 'üéâ All tests passed!' : passRate >= 80 ? '‚ö†Ô∏è Most tests passed' : '‚ùå Multiple failures'}
        </div>
      `;

      document.getElementById('results').insertBefore(summaryDiv, document.getElementById('results').firstChild);
    }

    async function runAllTests() {
      clearResults();

      try {
        // First, navigate to demo page in iframe or new window
        addInfo('Setup', 'Opening demo page to run tests...', {
          url: 'http://localhost:3000/demo',
          instructions: 'Tests will check the demo page\'s window object'
        });

        // Wait a bit for page to load
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Test 1: Check if ExposureCollector is initialized
        addInfo('Test 1', 'Checking ExposureCollector initialization...');
        const hasCollector = typeof window.ExposureCollector !== 'undefined';
        if (hasCollector) {
          const collector = window.ExposureCollector.getInstance();
          addResult(
            'Test 1: ExposureCollector Initialized',
            true,
            'ExposureCollector singleton is initialized',
            { hasInstance: !!collector }
          );
        } else {
          addResult(
            'Test 1: ExposureCollector Initialized',
            false,
            'ExposureCollector not found on window object (open demo page and run tests there)'
          );
        }

        // Test 2: Check registered tools
        if (hasCollector) {
          addInfo('Test 2', 'Checking registered tools...');
          const collector = window.ExposureCollector.getInstance();
          const tools = collector.getAllTools();
          const pass = tools.length > 0;
          addResult(
            'Test 2: Tools Registered',
            pass,
            pass ? `Found ${tools.length} registered tools` : 'No tools registered',
            { toolCount: tools.length, sampleTools: tools.slice(0, 3).map(t => ({ toolId: t.toolId, state: t.state })) }
          );
        }

        // Test 3: Check LocationContext.elements
        if (typeof window.LocationContext !== 'undefined') {
          addInfo('Test 3', 'Checking LocationContext.elements...');
          const location = window.LocationContext.getCurrent();
          const pass = location && location.elements && location.elements.length > 0;
          addResult(
            'Test 3: LocationContext Elements Populated',
            pass,
            pass ? `Found ${location.elements.length} visible elements` : 'LocationContext.elements is empty',
            { page: location?.page, elementCount: location?.elements?.length, elements: location?.elements?.slice(0, 5) }
          );
        } else {
          addResult(
            'Test 3: LocationContext Elements Populated',
            false,
            'LocationContext not found (open demo page and run tests there)'
          );
        }

        // Test 4: Check ToolRegistry filtering
        if (typeof window.ToolRegistry !== 'undefined') {
          addInfo('Test 4', 'Checking ToolRegistry filtering...');
          const tools = window.ToolRegistry.getToolsByLocation();
          const pass = tools.length > 0;
          addResult(
            'Test 4: Tools Filtered by Location',
            pass,
            pass ? `${tools.length} tools available at current location` : 'No tools available',
            { toolCount: tools.length, sampleTools: tools.slice(0, 3).map(t => ({ name: t.name, elementId: t.elementId })) }
          );
        } else {
          addResult(
            'Test 4: Tools Filtered by Location',
            false,
            'ToolRegistry not found (open demo page and run tests there)'
          );
        }

        // Test 5: Verify zero-config (no containerId)
        if (typeof window.ToolRegistry !== 'undefined') {
          addInfo('Test 5', 'Checking for zero-config (no containerId)...');
          const allTools = window.ToolRegistry.getAllTools();
          const demoTools = allTools.filter(t => t.name?.includes('Demo') || t.name?.includes('Widget') || t.name?.includes('Priority'));
          const toolsWithContainerId = demoTools.filter(t => t.containerId);
          const zeroConfigPercent = demoTools.length > 0 ? Math.round((1 - toolsWithContainerId.length / demoTools.length) * 100) : 0;
          const pass = zeroConfigPercent >= 90; // At least 90% should be zero-config
          addResult(
            'Test 5: Zero-Config Verification',
            pass,
            `${zeroConfigPercent}% of demo tools are zero-config (no containerId)`,
            {
              totalDemoTools: demoTools.length,
              withContainerId: toolsWithContainerId.length,
              zeroConfig: demoTools.length - toolsWithContainerId.length,
              percentage: zeroConfigPercent + '%'
            }
          );
        }

        // Show summary
        showSummary();

      } catch (error) {
        addResult(
          'Test Suite',
          false,
          'Error running tests: ' + error.message,
          { error: error.toString(), stack: error.stack }
        );
      }
    }

    // Instructions
    addInfo('Instructions', 'How to run these tests:', {
      step1: 'Open http://localhost:3000/demo in a new tab',
      step2: 'Open browser console (F12) on the demo page',
      step3: 'Copy and paste the test code from console, OR',
      step4: 'Navigate to this page from the demo page and click "Run All Tests"'
    });
  </script>
</body>
</html>
